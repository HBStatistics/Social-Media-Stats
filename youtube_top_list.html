<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top Subscribers • SocialMediaStats</title>

  <link rel="icon" href="https://yt3.ggpht.com/6lkWihxgCBYVkxdzFdKlAnEQfVhHL9BxcMzeUORTzBepIZ6YzUTYWQXCJ_s-86YQHMLJQb0IrA=s600-c-k-c0x00ffffff-no-rj-rp-mo" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg:#0f0f0f;
      --card:#1f1f1f;
      --radius:12px;
      --accent:#fe4a49;
      --accent2:#2ab7ca;
      --muted:#888;
      --text:#f1f1f1;
      --shadow:0 16px 48px rgba(0,0,0,0.3);
      --transition:.22s ease-out;
      font-family: 'Poppins', system-ui,-apple-system,sans-serif;
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      line-height:1.4;
    }
    a {color: inherit; text-decoration:none;}
    .container {
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px 16px 80px;
    }
    header {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      padding:16px 0 6px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      margin-bottom:12px;
      justify-content: space-between;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:1.3rem;
    }
    .brand img {width:32px; height:32px; border-radius:4px;}
    .nav {
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      font-size:.9em;
    }
    .nav a {
      padding: 8px 12px;
      border-radius:8px;
      transition: background var(--transition);
    }
    .nav a:hover {background: rgba(255,255,255,0.08);}
    .badge {
      background: linear-gradient(135deg,var(--accent),var(--accent2));
      padding:6px 14px;
      border-radius:999px;
      font-size:.55em;
      font-weight:700;
      color:#fff;
      text-transform:uppercase;
      display:inline-block;
      letter-spacing:1px;
    }
    h1 {
      margin:8px 0 6px;
      font-size:2rem;
      font-weight:700;
    }
    .sub {
      font-size:.95em;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom: 14px;
      align-items:center;
      justify-content: space-between;
      background: rgba(255,255,255,0.02);
      padding:12px 16px;
      border-radius:10px;
      font-size:.9em;
    }
    .controls .left {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .controls input {
      padding:10px 14px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      color:#fff;
      outline:none;
      font-size:.9em;
      min-width:220px;
    }
    .controls button {
      cursor:pointer;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background: linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
      transition:filter var(--transition), transform var(--transition);
      font-size:.85em;
    }
    .controls button:disabled {opacity:.6; cursor:not-allowed;}
    .controls button:hover {filter:brightness(1.05); transform:translateY(-1px);}

    .table-wrapper {overflow-x:auto; margin-top:6px;}
    table {
      width:100%;
      border-collapse:collapse;
      font-size:.9em;
      min-width: 900px;
    }
    thead {background: rgba(255,255,255,0.03);}
    th, td {
      padding:12px 10px;
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    tbody tr {
      border-bottom:1px solid rgba(255,255,255,0.08);
      transition: background var(--transition);
      cursor: pointer;
    }
    tbody tr:hover {background: rgba(255,255,255,0.04);}
    .rank {font-weight:700; width:50px;}
    .channel-cell {
      display:flex;
      gap:12px;
      align-items:center;
      max-width: 360px;
    }
    .avatar {
      width:52px;
      height:52px;
      border-radius:50%;
      overflow:hidden;
      flex-shrink:0;
      background:#222;
    }
    .avatar img {
      width:100%; height:100%; object-fit:cover;
    }
    .info-col {
      display:flex;
      flex-direction:column;
      gap:4px;
      overflow:hidden;
    }
    .channel-title {
      font-weight:600;
      line-height:1.1;
      font-size:1em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .subtext {
      font-size:.65em;
      color: var(--muted);
    }
    .metric {font-weight:600;}
    .small {font-size:.65em; color: var(--muted);}
    .pill {background: rgba(255,255,255,0.03); padding:6px 12px; border-radius:999px; font-size:.6em; display:inline-block; margin-right:6px;}
    .note {
      background: rgba(255,255,255,0.04);
      padding:10px 14px;
      border-radius:8px;
      margin:16px 0;
      display:flex;
      gap:10px;
      align-items:center;
      font-size:.85em;
    }
    .spinner {
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,0.2);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .8s linear infinite;
      display:inline-block;
      vertical-align:middle;
      margin-right:6px;
    }
    @keyframes spin {to{transform:rotate(360deg);}}

    .error {
      background: rgba(254,74,73,0.1);
      padding:12px 14px;
      border-radius:8px;
      margin-bottom:10px;
      display:flex;
      gap:10px;
      align-items:center;
      font-size:.9em;
    }
    .footer {
      text-align:center;
      margin-top:60px;
      font-size:.75em;
      color: var(--muted);
      padding-bottom:40px;
    }
    @media (max-width: 1000px){
      table {min-width: auto;}
      .controls {flex-direction:column; align-items:flex-start;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="https://yt3.ggpht.com/6lkWihxgCBYVkxdzFdKlAnEQfVhHL9BxcMzeUORTzBepIZ6YzUTYWQXCJ_s-86YQHMLJQb0IrA=s600-c-k-c0x00ffffff-no-rj-rp-mo" alt="logo"/>
        SocialMediaStats
        <div class="badge">Top Subscribers</div>
      </div>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="api.html">API Docs</a>
      </nav>
    </header>

    <section id="top-subscribers">
      <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:8px; align-items:flex-start;">
        <div style="flex:1; min-width:300px;">
          <h1>Top YouTube Channels by Subscribers</h1>
          <div class="sub">
            Powered by your <code>channels.json</code> (Top 500 list) plus live enrichment from YouTube Data API. Shows location (country), subscriber count, total views, video count, etc. Click a row or name/avatar to view analytics. Incremental loading for performance.
          </div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <div class="controls">
            <div class="left">
              <label for="searchInput" class="small" style="margin-right:4px;">Filter:</label>
              <input id="searchInput" placeholder="Search channel name or country…" aria-label="Filter"/>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="loadMoreBtn">Load more</button>
              <button id="refreshBtn">Refresh all</button>
            </div>
          </div>
        </div>
      </div>

      <div id="statusArea"></div>

      <div class="table-wrapper">
        <table aria-label="Top subscriber channels">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th>Channel</th>
              <th>Location</th>
              <th>Subscribers</th>
              <th>Total Views</th>
              <th>Video Count</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="channelsTbody">
            <!-- dynamic rows -->
          </tbody>
        </table>
      </div>

      <div class="note">
        <div class="pill">Data flow</div>
        <div style="flex:1;">
          The master list comes from <code>channels.json</code>. Details are fetched in batches from YouTube's API: subscriber count, views, video count, and country. Rows and names/avatar link to your analytics page. The list is sorted live by subscribers.
        </div>
      </div>
    </section>

    <div class="footer">
      © 2025 SocialMediaStats. Channels with hidden subscriber counts display “Hidden.”
    </div>
  </div>

  <script>
    // CONFIGURATION
    const YT_API_KEY = 'AIzaSyCFnGmkOPf7AtiAfGjML4qwWtG0TfbT3xs'; // inserted per request
    const CHANNEL_JSON_PATH = 'channels.json'; // should contain top 500 list
    const PER_LOAD = 100; // incremental load size
    const MAX_BATCH = 50; // YouTube API limit per request

    // STATE
    let allChannelEntries = [];
    let currentIndex = 0;
    const channelsData = new Map();
    const tbody = document.getElementById('channelsTbody');
    const statusArea = document.getElementById('statusArea');
    const searchInput = document.getElementById('searchInput');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    function showStatus(html) {
      statusArea.innerHTML = html;
    }
    function clearStatus() {
      statusArea.innerHTML = '';
    }

    function formatNumber(n) {
      if (n === undefined || n === null) return '--';
      if (n === 'Hidden') return 'Hidden';
      const num = Number(n);
      if (isNaN(num)) return n;
      if (num >= 1e9) return (num/1e9).toFixed(1) + 'B';
      if (num >= 1e6) return (num/1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num/1e3).toFixed(1) + 'K';
      return num.toLocaleString();
    }

    function countryFromResource(ch) {
      return ch.snippet?.country || ch.brandingSettings?.channel?.country || '—';
    }

    function buildAnalyticsUrl(channelId) {
      return `analytics.html?channelId=${encodeURIComponent(channelId)}`;
    }

    function sortAndRender() {
      const list = Array.from(channelsData.values());
      list.sort((a, b) => {
        const aHidden = a.statistics?.hiddenSubscriberCount;
        const bHidden = b.statistics?.hiddenSubscriberCount;
        const aSubs = aHidden ? 0 : Number(a.statistics?.subscriberCount || 0);
        const bSubs = bHidden ? 0 : Number(b.statistics?.subscriberCount || 0);
        return bSubs - aSubs;
      });

      const filter = searchInput.value.trim().toLowerCase();
      tbody.innerHTML = '';
      list.forEach((ch, idx) => {
        const title = ch.snippet?.title || 'Unknown';
        const customUrl = ch.snippet?.customUrl;
        const subscribers = ch.statistics?.hiddenSubscriberCount ? 'Hidden' : formatNumber(ch.statistics?.subscriberCount);
        const views = formatNumber(ch.statistics?.viewCount);
        const videoCount = formatNumber(ch.statistics?.videoCount);
        const location = countryFromResource(ch);
        const avatar = ch.snippet?.thumbnails?.default?.url || '';
        const channelId = ch.id;
        const channelUrl = `https://www.youtube.com/channel/${channelId}`;
        const analyticsUrl = buildAnalyticsUrl(channelId);

        if (filter) {
          const inName = title.toLowerCase().includes(filter);
          const inCountry = location.toLowerCase().includes(filter);
          if (!inName && !inCountry) return;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${idx + 1}</td>
          <td>
            <div class="channel-cell">
              <div class="avatar">
                <a href="${analyticsUrl}" aria-label="${title}">
                  <img loading="lazy" src="${avatar}" alt="${title}"/>
                </a>
              </div>
              <div class="info-col">
                <div class="channel-title">
                  <a href="${analyticsUrl}">${title}</a>
                </div>
                <div class="subtext">${customUrl ? '@' + customUrl : ''}</div>
              </div>
            </div>
          </td>
          <td>${location}</td>
          <td class="metric">${subscribers}</td>
          <td class="metric">${views}</td>
          <td class="metric">${videoCount}</td>
          <td>
            <a href="${channelUrl}" target="_blank" style="display:inline-block;padding:6px 12px;border-radius:6px;background:rgba(254,74,73,1);color:#fff;font-size:.75em;font-weight:600;">View</a>
          </td>
        `;
        tr.addEventListener('click', e => {
          if (e.target.closest('a') || e.target.closest('button')) return;
          window.location.href = analyticsUrl;
        });
        tbody.appendChild(tr);
      });
    }

    async function fetchChannelBatch(ids) {
      if (!YT_API_KEY || YT_API_KEY === 'YOUR_YOUTUBE_API_KEY') {
        // this check stays in case someone reuses template without replacing
        throw new Error('You must replace the API key.');
      }
      const results = [];
      for (let i = 0; i < ids.length; i += MAX_BATCH) {
        const chunk = ids.slice(i, i + MAX_BATCH);
        const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${encodeURIComponent(chunk.join(','))}&key=${encodeURIComponent(YT_API_KEY)}`;
        const res = await fetch(url);
        if (!res.ok) {
          const payload = await res.json().catch(()=>null);
          const msg = payload?.error?.message ? payload.error.message : `HTTP ${res.status}`;
          throw new Error(msg);
        }
        const data = await res.json();
        if (Array.isArray(data.items)) {
          results.push(...data.items);
        }
      }
      return results;
    }

    async function loadMasterList() {
      showStatus(`<div class="note"><span class="spinner"></span>Loading master channel list from channels.json...</div>`);
      try {
        const r = await fetch(CHANNEL_JSON_PATH);
        if (!r.ok) throw new Error(`Failed to load ${CHANNEL_JSON_PATH}: ${r.status}`);
        const json = await r.json();
        allChannelEntries = json.map(entry => {
          if (typeof entry === 'string') return { id: entry };
          if (entry && typeof entry === 'object' && entry.id) return { id: entry.id, customTitle: entry.customTitle };
          return null;
        }).filter(Boolean);
        if (allChannelEntries.length === 0) {
          throw new Error('channels.json contained no valid entries.');
        }
        allChannelEntries = allChannelEntries.slice(0, 500);
        currentIndex = 0;
        clearStatus();
        await loadNextChunk();
      } catch (err) {
        showStatus(`<div class="error">Error loading master list: ${err.message}</div>`);
      }
    }

    async function loadNextChunk() {
      if (currentIndex >= allChannelEntries.length) return;
      const toLoad = allChannelEntries.slice(currentIndex, currentIndex + PER_LOAD);
      const ids = toLoad.map(e => e.id);
      showStatus(`<div class="note"><span class="spinner"></span>Fetching details for channels ${currentIndex + 1}–${Math.min(currentIndex + PER_LOAD, allChannelEntries.length)} of ${allChannelEntries.length}...</div>`);
      try {
        const fetched = await fetchChannelBatch(ids);
        fetched.forEach(ch => {
          const master = allChannelEntries.find(e => e.id === ch.id);
          if (master && master.customTitle) {
            if (!ch.snippet) ch.snippet = {};
            ch.snippet.title = master.customTitle;
          }
          channelsData.set(ch.id, ch);
        });
        currentIndex += toLoad.length;
        sortAndRender();
        clearStatus();
        updateLoadMoreUI();
      } catch (err) {
        showStatus(`<div class="error">Failed to fetch channel details: ${err.message}</div>`);
      }
    }

    function updateLoadMoreUI() {
      if (currentIndex >= allChannelEntries.length) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'All loaded';
      } else {
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = `Load more (${currentIndex}/${allChannelEntries.length})`;
      }
    }

    async function refreshAll() {
      channelsData.clear();
      currentIndex = 0;
      await loadNextChunk();
    }

    searchInput.addEventListener('input', () => {
      sortAndRender();
    });
    loadMoreBtn.addEventListener('click', loadNextChunk);
    refreshBtn.addEventListener('click', refreshAll);

    document.addEventListener('DOMContentLoaded', loadMasterList);
  </script>
</body>
</html>

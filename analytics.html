<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Channel Analytics â€¢ SocialMediaStats</title>

  <link rel="icon" href="https://yt3.ggpht.com/6lkWihxgCBYVkxdzFdKlAnEQfVhHL9BxcMzeUORTzBepIZ6YzUTYWQXCJ_s-86YQHMLJQb0IrA=s600-c-k-c0x00ffffff-no-rj-rp-mo" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Odometer -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/themes/odometer-theme-minimal.min.css" />

  <style>
    :root {
      --bg: linear-gradient(135deg,#0f0f0f,#1b1b1b);
      --card: rgba(255,255,255,0.02);
      --radius:16px;
      --accent1:#fe4a49;
      --accent2:#2ab7ca;
      --text:#e8e8e8;
      --muted:#8f9bb3;
      --shadow:0 40px 80px -10px rgba(0,0,0,0.6);
      --transition:.25s cubic-bezier(.4,.2,.2,1);
      font-family: 'Poppins', system-ui,-apple-system,sans-serif;
    }
    *{box-sizing:border-box;}
    body {
      margin:0;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
      line-height:1.35;
      overflow-x:hidden;
    }
    a {color: inherit; text-decoration:none;}
    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px 18px 100px;
      position: relative;
      z-index:1;
      animation: fadeIn .8s ease both;
    }
    @keyframes fadeIn {
      from {opacity:0; transform: translateY(6px);}
      to {opacity:1; transform: translateY(0);}
    }
    nav {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
      padding:14px 0 6px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      gap:8px;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:1.1rem;
    }
    .brand img {width:28px; height:28px; border-radius:6px; display:block;}
    .nav-links {display:flex; gap:16px; font-size:.85em;}
    .nav-links a {
      padding:8px 14px;
      border-radius:999px;
      transition: background var(--transition), transform var(--transition);
      position:relative;
      font-weight:600;
      background: rgba(255,255,255,0.04);
    }
    .nav-links a:hover {background: rgba(255,255,255,0.08); transform: translateY(-1px);}
    .title-row {
      display:flex;
      flex-wrap:wrap;
      justify-content: space-between;
      gap:16px;
      margin-top:4px;
      align-items:flex-start;
      position:relative;
    }
    h1 {
      margin:0;
      font-size:2.1rem;
      font-weight:700;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .subtitle {
      margin-top:4px;
      font-size:.9em;
      color: var(--muted);
    }
    .fancy-badge {
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      padding:8px 18px;
      border-radius:999px;
      font-size:.55em;
      font-weight:700;
      color:#fff;
      text-transform:uppercase;
      display:inline-block;
      letter-spacing:1px;
    }
    .tabs {
      margin-top:14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab {
      padding:10px 18px;
      border-radius:999px;
      font-size:.75em;
      font-weight:600;
      cursor:pointer;
      background: rgba(255,255,255,0.05);
      position: relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: all var(--transition);
    }
    .tab.active {
      background: rgba(255,255,255,0.15);
      color:#fff;
    }
    .tab.active:after {
      content:'';
      position:absolute;
      bottom:-4px;
      left:50%;
      transform:translateX(-50%);
      width:60%;
      height:4px;
      border-radius:2px;
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      box-shadow: 0 8px 24px rgba(254,74,73,0.6);
    }

    /* Beta banner styled like home page disclaimer */
    .beta-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(254,74,73,0.1);
      color: var(--accent1);
      border: 1px solid var(--accent1);
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      margin-top: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .beta-banner button {
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--accent1);
      font-weight: 700;
      font-size: 1rem;
      line-height: 1;
    }

    .metrics-row {
      margin-top:24px;
      display:flex;
      gap:16px;
      flex-wrap:wrap;
    }
    .metric-card {
      flex:1 1 140px;
      background: radial-gradient(circle at 30% 40%, rgba(255,255,255,0.04), transparent 70%), var(--card);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      padding:18px 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-width:120px;
      position: relative;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .metric-card:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 55px 90px -15px rgba(255,80,100,0.3);
    }
    .metric-title {
      text-transform: uppercase;
      font-size:.55em;
      letter-spacing:1px;
      font-weight:600;
      color: var(--muted);
      margin-bottom:6px;
    }
    .metric-value {
      font-weight:700;
      font-size:1.6rem;
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1;
      white-space: nowrap;
      position: relative;
    }
    .profile {
      margin-top:26px;
      display:flex;
      flex-wrap:wrap;
      gap:24px;
      align-items:flex-start;
      position: relative;
    }
    .profile:before {
      content:'';
      position:absolute;
      top:-20px;
      right:-50px;
      width:260px;
      height:260px;
      background: radial-gradient(circle at 40% 40%, rgba(42,183,202,0.15), transparent 65%);
      filter: blur(70px);
      pointer-events:none;
      border-radius:50%;
    }
    .left {
      flex:1;
      min-width:280px;
      display:flex;
      gap:18px;
      flex-wrap:wrap;
    }
    .avatar {
      width:96px;
      height:96px;
      border-radius:50%;
      overflow:hidden;
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      padding:4px;
      position: relative;
      flex-shrink:0;
      box-shadow: 0 25px 60px -5px rgba(42,183,202,0.6);
    }
    .avatar img {
      width:100%; height:100%; object-fit:cover;
      border-radius:50%;
      display:block;
    }
    .info {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:180px;
    }
    .channel-name {
      font-size:1.75rem;
      font-weight:700;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .handle {
      font-size:1rem;
      color: #d1d9f0;
      background: rgba(255,255,255,0.03);
      padding:6px 14px;
      border-radius:999px;
      display:inline-block;
      font-weight:500;
    }
    .meta {
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      font-size:.75em;
      color: var(--muted);
      margin-top:4px;
    }
    .desc {
      font-size:.95em;
      margin-top:6px;
      position: relative;
      background: rgba(255,255,255,0.01);
      padding:10px 14px;
      border-radius:10px;
      max-width: 800px;
      overflow: hidden;
    }
    .toggles {
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .toggle-btn {
      padding:8px 16px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      font-size:.65em;
      cursor:pointer;
      font-weight:600;
      transition: background var(--transition);
    }
    .toggle-btn.active {
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      color:#fff;
    }

    .stats-section {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      gap:20px;
      margin-top:26px;
    }
    .card {
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.02), transparent 80%), var(--card);
      border-radius:16px;
      padding:22px 24px;
      position: relative;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:16px;
      backdrop-filter: blur(12px);
      border:1px solid rgba(255,255,255,0.06);
      transition: transform var(--transition);
    }
    .card:hover { transform: translateY(-2px); }
    .summary-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
      gap:14px;
      margin-top:8px;
    }
    .stat {
      background: rgba(255,255,255,0.04);
      border-radius:12px;
      padding:14px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position: relative;
      overflow:hidden;
      min-height:72px;
    }
    .stat .label {
      font-size:.55em;
      text-transform:uppercase;
      letter-spacing:1px;
      color: var(--muted);
      font-weight:600;
    }
    .stat .value {
      font-size:1.05rem;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      white-space: normal;
      word-break: break-word;
      line-height:1.1;
    }
    .growth-row {
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .growth-card {
      flex:1 1 240px;
      background: rgba(255,255,255,0.02);
      border-radius:12px;
      padding:16px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      position: relative;
      border:1px solid rgba(255,255,255,0.06);
    }
    .grow-title {
      font-weight:700;
      font-size:1rem;
      margin-bottom:2px;
    }
    .grow-values {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .grow-box {
      flex:1;
      background: rgba(255,255,255,0.03);
      border-radius:8px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sparkline-wrapper {
      position:relative;
      height:70px;
    }
    canvas.sparkline, canvas.realtime-spark {
      width:100%;
      height:100%;
      display:block;
    }

    .recent {
      margin-top:38px;
    }
    .section-title {
      display:flex;
      justify-content: space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .table-wrapper {
      overflow-x:auto;
      margin-top:8px;
      border-radius:12px;
      position: relative;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:.85em;
      background: rgba(0,0,0,0.05);
      border-radius:8px;
    }
    thead {background: rgba(255,255,255,0.07);}
    th, td {
      padding:10px 8px;
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    tbody tr {
      border-bottom:1px solid rgba(255,255,255,0.08);
      transition: background var(--transition);
    }
    tbody tr:hover {background: rgba(255,255,255,0.08);}
    .thumb {
      display:flex;
      gap:10px;
      align-items:center;
      max-width: 380px;
    }
    .thumb img {
      width:100px;
      height:56px;
      object-fit:cover;
      border-radius:6px;
      flex-shrink:0;
      background:#222;
    }
    .video-info {
      display:flex;
      flex-direction:column;
      gap:4px;
      overflow:hidden;
    }
    .video-title {
      font-weight:600;
      line-height:1.1;
      font-size:.9em;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .video-meta {
      font-size:.65em;
      color: var(--muted);
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .share-row {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }
    .copy-input {
      background: rgba(255,255,255,0.08);
      border:none;
      padding:10px 14px;
      border-radius:10px;
      color:#fff;
      font-size:.75em;
      outline:none;
      min-width:240px;
      flex:1;
      position: relative;
    }
    .btn {
      padding:10px 16px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
      border:none;
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      color:#fff;
      font-size:.75em;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: transform var(--transition), filter var(--transition);
      position: relative;
      overflow:hidden;
    }
    .btn:active {transform: scale(.97);}
    .btn-secondary {
      background: rgba(255,255,255,0.08);
    }
    .grade-badge {
      padding:6px 14px;
      border-radius:999px;
      font-weight:700;
      display:inline-block;
      font-size:.8em;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .gain-grades {
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      margin-top:8px;
      align-items:flex-start;
    }
    .gain-grade {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .gain-grade .label {
      font-size:.55em;
      text-transform:uppercase;
      letter-spacing:1px;
      color: var(--muted);
      font-weight:600;
    }

    .verification-banner {
      display:flex;
      gap:14px;
      align-items:flex-start;
      background: rgba(34,197,94,0.08);
      border:1px solid #22c55e;
      padding:14px 18px;
      border-radius:12px;
      margin:16px 0 8px;
      font-size:.9em;
      position: relative;
      overflow:hidden;
    }
    .verification-banner .check {
      font-size:1.8em;
      line-height:1;
    }

    .note {
      background: rgba(255,255,255,0.015);
      padding:16px 18px;
      border-radius:12px;
      margin-top:26px;
      font-size:.75em;
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,0.05);
    }

    .error {
      background: rgba(254,74,73,0.1);
      padding:12px 14px;
      border-radius:10px;
      margin-top:10px;
      font-size:.9em;
    }
    .small { font-size:.65em; color: var(--muted); }

    .footer {
      margin-top:100px;
      text-align:center;
      font-size:.65em;
      color: var(--muted);
      padding-bottom:40px;
    }

    .hidden { display:none !important; }

    @media (max-width: 1000px){
      .metrics-row { flex-direction:column; }
      .profile { flex-direction:column; }
      .title-row { flex-direction:column; }
      .summary-grid { grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); }
      .growth-row { flex-direction:column; }
      .metric-value { font-size:1.3rem; }
      .channel-name { font-size:1.45rem; }
    }
    .odometer { font-size:1.5rem !important; }
    .pulse {
      animation: pulseGlow 2s infinite ease-in-out;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 10px rgba(254,74,73,0.4); }
      50% { box-shadow: 0 0 28px rgba(254,74,73,0.6); }
      100% { box-shadow: 0 0 10px rgba(254,74,73,0.4); }
    }
  </style>
</head>

<body>
  <div class="container">
    <nav aria-label="main navigation">
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="brand">
          <img src="https://yt3.ggpht.com/6lkWihxgCBYVkxdzFdKlAnEQfVhHL9BxcMzeUORTzBepIZ6YzUTYWQXCJ_s-86YQHMLJQb0IrA=s600-c-k-c0x00ffffff-no-rj-rp-mo" alt="logo"/>
          SocialMediaStats
        </div>
      </div>
      <div class="nav-links">
        <a href="yotube_top_list.html">Top Subscribers</a>
        <a href="api.html">API Docs</a>
      </div>
    </nav>

    <div class="title-row">
      <div>
        <h1>Channel Analytics <div class="fancy-badge">YouTube</div></h1>
        <div class="subtitle" id="channelSubtitle">Loading channel data...</div>
      </div>
      <div class="share-row">
        <div class="small">Share:</div>
        <input id="shareLink" class="copy-input" readonly aria-label="Share link"/>
        <button class="btn" id="copyBtn">Copy</button>
        <button class="btn pulse" id="snapshotBtn">Record Snapshot</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" role="tab" data-target="analyticsContent">Channel Analytics</div>
      <div class="tab" role="tab" data-target="videoAnalyticsContent">Video Analytics</div>
      <div class="tab" role="tab" data-target="realtimeContent">Realtime</div>
      <div class="tab" role="tab" data-target="leaderboardContent">Leaderboard</div>
    </div>

    <!-- Beta banner like home page disclaimer -->
    <div class="beta-banner" role="status">
      <div>Beta: This website is in beta and experimental. If you encounter any bugs, please report them to the developers.</div>
      <button id="betaClose" aria-label="Dismiss beta banner">&times;</button>
    </div>

    <!-- CHANNEL ANALYTICS CONTENT -->
    <div id="analyticsContent">
      <div class="metrics-row" aria-label="primary metrics">
        <div class="metric-card">
          <div class="metric-title">Subscribers</div>
          <div class="metric-value"><div id="subsOdo" class="odometer">0</div></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Total Views</div>
          <div class="metric-value"><div id="viewsOdo" class="odometer">0</div></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Videos</div>
          <div class="metric-value" id="videoCount">â€”</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Grade</div>
          <div class="metric-value"><span id="grade" class="grade-badge">â€”</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Engagement</div>
          <div class="metric-value" id="engagement">â€”</div>
        </div>
      </div>

      <div id="verificationContainer"></div>

      <div class="profile">
        <div class="left">
          <div class="avatar">
            <img id="channelAvatar" src="" alt="Channel avatar"/>
          </div>
          <div class="info">
            <div class="channel-name" id="channelName">â€”</div>
            <div class="handle" id="customUrl">â€”</div>
            <div class="meta">
              <div id="publishedDate">Created â€”</div>
              <div id="country">Country â€”</div>
            </div>
            <div class="desc" id="descriptionShort"></div>
            <div class="toggles">
              <div class="toggle-btn active" data-period="7">Past 7 days</div>
              <div class="toggle-btn" data-period="30">Past 30 days</div>
              <div class="toggle-btn" data-period="365">Past 365 days</div>
              <div class="toggle-btn" data-period="all">All</div>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-section">
        <div class="card">
          <div style="display:flex; justify-content: space-between; flex-wrap:wrap; gap:10px;">
            <div style="font-weight:700; font-size:1.05rem;">Growth & History</div>
            <div class="small" id="lastSnapshotTime">â€”</div>
          </div>
          <div class="growth-row">
            <div class="growth-card">
              <div class="grow-title">Subscriber History</div>
              <div class="small">Local snapshots</div>
              <div class="sparkline-wrapper">
                <canvas id="subsSpark" class="sparkline" aria-label="subscriber sparkline"></canvas>
              </div>
              <div class="grow-values">
                <div class="grow-box">
                  <div class="small">Latest</div>
                  <div id="latestSubs">â€”</div>
                </div>
                <div class="grow-box">
                  <div class="small">Previous</div>
                  <div id="prevSubs">â€”</div>
                </div>
                <div class="grow-box">
                  <div class="small">Delta</div>
                  <div id="deltaSubs">â€”</div>
                </div>
              </div>
            </div>
            <div class="growth-card">
              <div class="grow-title">View History</div>
              <div class="small">Local snapshots</div>
              <div class="sparkline-wrapper">
                <canvas id="viewsSpark" class="sparkline" aria-label="views sparkline"></canvas>
              </div>
              <div class="grow-values">
                <div class="grow-box">
                  <div class="small">Latest</div>
                  <div id="latestViews">â€”</div>
                </div>
                <div class="grow-box">
                  <div class="small">Previous</div>
                  <div id="prevViews">â€”</div>
                </div>
                <div class="grow-box">
                  <div class="small">Delta</div>
                  <div id="deltaViews">â€”</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content: space-between; flex-wrap:wrap; gap:10px;">
            <div style="font-weight:700; font-size:1.05rem;">Quick Metrics</div>
            <div class="small">Computed</div>
          </div>
          <div class="summary-grid">
            <div class="stat">
              <div class="label">Subscriber Velocity</div>
              <div class="value" id="velocity">â€”</div>
            </div>
            <div class="stat">
              <div class="label">View Velocity</div>
              <div class="value" id="viewVelocity">â€”</div>
            </div>
            <div class="stat">
              <div class="label">30d Projection (subs)</div>
              <div class="value" id="projection">â€”</div>
            </div>
            <div class="stat">
              <div class="label">Upload Frequency</div>
              <div class="value" id="uploadFreq">â€”</div>
            </div>
            <div class="stat">
              <div class="label">Est. Monthly Earnings</div>
              <div class="value" id="estMonthlyEarnings" title="Estimated monthly revenue range">â€”</div>
            </div>
            <div class="stat">
              <div class="label">Est. Yearly Earnings</div>
              <div class="value" id="estYearlyEarnings" title="Estimated yearly revenue range">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="thirtyDayActivityCard">
        <div style="display:flex; justify-content: space-between; flex-wrap:wrap; gap:10px;">
          <div style="font-weight:700; font-size:1.05rem;">Last 30 Days Activity</div>
          <div class="small" id="thirtyDaySummary">â€”</div>
        </div>

        <div class="gain-grades">
          <div class="gain-grade">
            <div class="label">Subs Gain Rank</div>
            <div id="subsGainGrade" class="grade-badge" style="background:rgba(255,255,255,0.07);color:#ccc;">â€”</div>
          </div>
          <div class="gain-grade">
            <div class="label">Views Gain Rank</div>
            <div id="viewsGainGrade" class="grade-badge" style="background:rgba(255,255,255,0.07);color:#ccc;">â€”</div>
          </div>
        </div>

        <div class="table-wrapper">
          <table aria-label="30 day activity" id="thirtyDayTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Subscribers</th>
                <th>Î” Subs</th>
                <th>Views</th>
                <th>Î” Views</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>Total / Avg</th>
                <th id="totalSubsGain">â€”</th>
                <th id="avgSubsPerDay">â€”</th>
                <th id="totalViewsGain">â€”</th>
                <th id="avgViewsPerDay">â€”</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="recent">
        <div class="section-title">
          <div>
            <h2 style="margin:0;">Recent Uploads</h2>
            <div class="small">Latest videos from this channel</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="refreshVideos">Refresh</button>
          </div>
        </div>
        <div id="videosError"></div>
        <div class="table-wrapper">
          <table aria-label="Recent uploads">
            <thead>
              <tr>
                <th style="width:40px;">#</th>
                <th>Title</th>
                <th>Published</th>
                <th>Views</th>
                <th>Duration</th>
                <th>Watch</th>
              </tr>
            </thead>
            <tbody id="videosTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="note">
        <div>Subscribers and view history are stored locally (now in IndexedDB) for trend computation. Earnings, velocity, and grade are estimates based on publicly available statistics. Realtime subscriber count uses Mixerno.Space API.</div>
      </div>
    </div>

    <div id="videoAnalyticsContent" class="hidden">
      <div class="card">
        <div style="font-weight:700; font-size:1.1rem;">Video Analytics</div>
        <div class="small">Coming soon.</div>
      </div>
    </div>

    <div id="realtimeContent" class="hidden">
      <div class="card" style="margin-top:14px;">
        <div style="display:flex; justify-content: space-between; flex-wrap:wrap; gap:12px;">
          <div style="font-weight:700; font-size:1.1rem;">Realtime Snapshot</div>
          <div class="small" id="liveLastUpdated">â€”</div>
        </div>
        <div class="gain-grades" style="margin-top:12px;">
          <div class="gain-grade">
            <div class="label">Realtime Subscribers</div>
            <div class="grade-badge" style="background:rgba(255,255,255,0.03); font-size:1.2rem; padding:10px 14px;">
              <div id="subsRealtime" class="odometer">0</div>
            </div>
          </div>
          <div class="gain-grade">
            <div class="label">Realtime Views</div>
            <div class="grade-badge" style="background:rgba(255,255,255,0.03); font-size:1.2rem; padding:10px 14px;">
              <div id="viewsRealtime" class="odometer">0</div>
            </div>
          </div>
          <div class="gain-grade">
            <div class="label">Subs Rate /day</div>
            <div id="subsRate" class="grade-badge" style="background: rgba(255,255,255,0.07);">â€”</div>
          </div>
          <div class="gain-grade">
            <div class="label">Views Rate /day</div>
            <div id="viewsRate" class="grade-badge" style="background: rgba(255,255,255,0.07);">â€”</div>
          </div>
        </div>

        <div class="card" style="margin-top:16px; padding:18px 20px;">
          <div style="display:flex; justify-content: space-between; flex-wrap:wrap;">
            <div style="font-weight:700; font-size:1rem;">Realtime Gains & Grades</div>
            <div class="small">Window â‰ˆ last 5m</div>
          </div>
          <div class="gain-grades" style="margin-top:8px;">
            <div class="gain-grade">
              <div class="label">Subscriber Gain Grade</div>
              <div id="realtimeSubsGainGrade" class="grade-badge" style="background:rgba(255,255,255,0.07);color:#ccc;">â€”</div>
            </div>
            <div class="gain-grade">
              <div class="label">View Gain Grade</div>
              <div id="realtimeViewsGainGrade" class="grade-badge" style="background:rgba(255,255,255,0.07);color:#ccc;">â€”</div>
            </div>
            <div class="gain-grade">
              <div class="label">Projected Subs /day</div>
              <div id="projSubsDay" class="grade-badge" style="background:rgba(255,255,255,0.07);">â€”</div>
            </div>
            <div class="gain-grade">
              <div class="label">Projected Views /day</div>
              <div id="projViewsDay" class="grade-badge" style="background:rgba(255,255,255,0.07);">â€”</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div style="display:flex; justify-content: space-between; flex-wrap:wrap;">
            <div style="font-weight:700; font-size:1rem;">Live Trend (â‰ˆ30m)</div>
            <div class="small">Updates every 10s</div>
          </div>
          <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:8px;">
            <div style="flex:1; min-width:180px;">
              <div class="small">Subscribers over time</div>
              <div class="sparkline-wrapper">
                <canvas id="sparkSubs" class="realtime-spark"></canvas>
              </div>
            </div>
            <div style="flex:1; min-width:180px;">
              <div class="small">Views over time</div>
              <div class="sparkline-wrapper">
                <canvas id="sparkViews" class="realtime-spark"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="realtimeVerification" class="verification-banner hidden">
        <div class="check">âœ…</div>
        <div>
          <div style="font-weight:700;">Subscriber count verified</div>
          <div style="font-size:.85em;" id="realtimeVerificationText"></div>
        </div>
      </div>

      <div class="note">
        <div>Realtime polling uses Mixerno.Space API for subscribers with YouTube used for views. Rates and grades are smoothed. For scale beyond client-side, migrate history to backend storage.</div>
      </div>
    </div>

    <div id="leaderboardContent" class="hidden">
      <div class="card">
        <div style="font-weight:700; font-size:1.1rem;">Leaderboard</div>
        <div class="small">Coming soon.</div>
      </div>
    </div>

    <div class="footer">
      Â© 2025 SocialMediaStats. Uses YouTube Data API v3 and Mixerno.Space for realtime subs.
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/odometer.min.js"></script>

  <script>
    const YT_API_KEY = 'AIzaSyCFnGmkOPf7AtiAfGjML4qwWtG0TfbT3xs';
    const MAX_HISTORY = 60;
    const SNAPSHOT_INTERVAL_MS = 1000 * 60 * 60 * 6;
    const params = new URLSearchParams(window.location.search);
    const channelId = params.get('channelId');

    // Elements
    const channelNameEl = document.getElementById('channelName');
    const channelSubtitleEl = document.getElementById('channelSubtitle');
    const channelAvatarEl = document.getElementById('channelAvatar');
    const customUrlEl = document.getElementById('customUrl');
    const publishedDateEl = document.getElementById('publishedDate');
    const countryEl = document.getElementById('country');
    const descriptionShortEl = document.getElementById('descriptionShort');
    const subsOdoEl = document.getElementById('subsOdo');
    const viewsOdoEl = document.getElementById('viewsOdo');
    const videoCountEl = document.getElementById('videoCount');
    const latestSubsEl = document.getElementById('latestSubs');
    const prevSubsEl = document.getElementById('prevSubs');
    const deltaSubsEl = document.getElementById('deltaSubs');
    const latestViewsEl = document.getElementById('latestViews');
    const prevViewsEl = document.getElementById('prevViews');
    const deltaViewsEl = document.getElementById('deltaViews');
    const velocityEl = document.getElementById('velocity');
    const viewVelocityEl = document.getElementById('viewVelocity');
    const projectionEl = document.getElementById('projection');
    const uploadFreqEl = document.getElementById('uploadFreq');
    const estMonthlyEl = document.getElementById('estMonthlyEarnings');
    const estYearlyEl = document.getElementById('estYearlyEarnings');
    const gradeEl = document.getElementById('grade');
    const engagementEl = document.getElementById('engagement');
    const lastSnapshotTimeEl = document.getElementById('lastSnapshotTime');
    const videosTbody = document.getElementById('videosTbody');
    const videosError = document.getElementById('videosError');
    const subsGainGradeEl = document.getElementById('subsGainGrade');
    const viewsGainGradeEl = document.getElementById('viewsGainGrade');
    const thirtyDaySummaryEl = document.getElementById('thirtyDaySummary');
    const totalSubsGainEl = document.getElementById('totalSubsGain');
    const avgSubsPerDayEl = document.getElementById('avgSubsPerDay');
    const totalViewsGainEl = document.getElementById('totalViewsGain');
    const avgViewsPerDayEl = document.getElementById('avgViewsPerDay');
    const shareLinkInput = document.getElementById('shareLink');
    const copyBtn = document.getElementById('copyBtn');
    const snapshotBtn = document.getElementById('snapshotBtn');
    const refreshVideosBtn = document.getElementById('refreshVideos');
    const verificationContainer = document.getElementById('verificationContainer');

    const subsRealtimeEl = document.getElementById('subsRealtime');
    const viewsRealtimeEl = document.getElementById('viewsRealtime');
    const subsRateEl = document.getElementById('subsRate');
    const viewsRateEl = document.getElementById('viewsRate');
    const projSubsDayEl = document.getElementById('projSubsDay');
    const projViewsDayEl = document.getElementById('projViewsDay');
    const realtimeSubsGainGradeEl = document.getElementById('realtimeSubsGainGrade');
    const realtimeViewsGainGradeEl = document.getElementById('realtimeViewsGainGrade');
    const sparkSubs = document.getElementById('sparkSubs');
    const sparkViews = document.getElementById('sparkViews');
    const liveLastUpdatedEl = document.getElementById('liveLastUpdated');
    const realtimeVerificationEl = document.getElementById('realtimeVerification');
    const realtimeVerificationText = document.getElementById('realtimeVerificationText');

    let analyticsHistory = [];
    let realtimeHistory = [];
    let lastKnownViews = 0;
    const viewStatsVerified = {
      'UCX6OQ3DkcsbYNE6H8uQQuVA': {
        displayName: 'MrBeast',
        method: 'ViewStats cross-check',
        note: 'Subscriber count is 100% accurate â€” cross-checked using high-frequency view-based growth trends matching official growth within Â±0.1%.',
      }
    };

    // Utils
    function formatNumber(n) {
      if (n === undefined || n === null) return '--';
      if (typeof n === 'string') return n;
      const num = Number(n);
      if (isNaN(num)) return n;
      if (num >= 1e9) return (num/1e9).toFixed(1) + 'B';
      if (num >= 1e6) return (num/1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num/1e3).toFixed(1) + 'K';
      return num.toLocaleString();
    }
    function timeAgo(dateStr) {
      if (!dateStr) return 'â€”';
      const then = new Date(dateStr);
      const now = new Date();
      const diff = Math.floor((now - then) / 1000);
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
      if (diff < 604800) return `${Math.floor(diff/86400)}d ago`;
      const days = Math.floor(diff/86400);
      return `${days}d ago`;
    }
    function parseDuration(iso) {
      if (!iso) return '';
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return iso;
      const h = parseInt(match[1]||0,10);
      const m = parseInt(match[2]||0,10);
      const s = parseInt(match[3]||0,10);
      const pad = (v) => v.toString().padStart(2,'0');
      if (h) return `${h}:${pad(m)}:${pad(s)}`;
      return `${m}:${pad(s)}`;
    }

    // IndexedDB for history
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open('smsAnalytics', 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('history')) {
            db.createObjectStore('history', { keyPath: 'channelId' });
          }
        };
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e.target.error);
      });
    }
    async function getHistory(cid) {
      try {
        const db = await openDB();
        const tx = db.transaction('history', 'readonly');
        const store = tx.objectStore('history');
        const rec = await new Promise((res, rej) => {
          const r = store.get(cid);
          r.onsuccess = () => res(r.result);
          r.onerror = () => rej(r.error);
        });
        if (rec && Array.isArray(rec.entries)) return rec.entries;
        const legacy = localStorage.getItem(`sms_analytics_history_${cid}`);
        if (legacy) {
          try {
            const arr = JSON.parse(legacy);
            await saveHistory(cid, arr);
            localStorage.removeItem(`sms_analytics_history_${cid}`);
            return arr;
          } catch {}
        }
        return [];
      } catch (e) {
        console.warn('IDB load error', e);
        return [];
      }
    }
    async function saveHistory(cid, entries) {
      try {
        const db = await openDB();
        const tx = db.transaction('history', 'readwrite');
        const store = tx.objectStore('history');
        const payload = { channelId: cid, entries: entries.slice(-MAX_HISTORY) };
        await new Promise((res, rej) => {
          const r = store.put(payload);
          r.onsuccess = () => res();
          r.onerror = () => rej(r.error);
        });
      } catch (e) {
        console.warn('IDB save error', e);
      }
    }
    async function recordAnalyticsSnapshot(current) {
      const now = Date.now();
      let hist = await getHistory(channelId);
      const last = hist[hist.length - 1];
      if (last && now - last.ts < SNAPSHOT_INTERVAL_MS) return {};
      hist.push({ ts: now, subs: current.subs, views: current.views });
      await saveHistory(channelId, hist);
      return updateAnalyticsHistoryDisplay(hist);
    }

    function drawSparkline(canvas, values) {
      const ctx = canvas.getContext('2d');
      const dpr = devicePixelRatio || 1;
      const w = canvas.clientWidth * dpr;
      const h = canvas.clientHeight * dpr;
      canvas.width = w;
      canvas.height = h;
      ctx.resetTransform();
      ctx.scale(dpr, dpr);
      const displayW = canvas.clientWidth;
      const displayH = canvas.clientHeight;
      ctx.clearRect(0, 0, displayW, displayH);
      if (!values || values.length === 0) return;
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = Math.max(1, max - min);
      const padding = 6;
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#fff';
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.beginPath();
      values.forEach((v,i) => {
        const x = padding + (i / (values.length - 1)) * (displayW - padding*2);
        const y = padding + ((max - v) / range) * (displayH - padding*2);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.lineTo(displayW - padding, displayH - padding);
      ctx.lineTo(padding, displayH - padding);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      values.forEach((v,i) => {
        const x = padding + (i / (values.length - 1)) * (displayW - padding*2);
        const y = padding + ((max - v) / range) * (displayH - padding*2);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function updateAnalyticsHistoryDisplay(history) {
      if (!history || history.length === 0) return {};
      const latest = history[history.length -1];
      const prev = history[history.length -2] || null;

      latestSubsEl.textContent = formatNumber(latest.subs);
      latestViewsEl.textContent = formatNumber(latest.views);
      let subsVel = 0, viewsVel = 0;
      if (prev) {
        prevSubsEl.textContent = formatNumber(prev.subs);
        prevViewsEl.textContent = formatNumber(prev.views);
        const deltaSubs = latest.subs - prev.subs;
        const deltaViews = latest.views - prev.views;
        deltaSubsEl.textContent = (deltaSubs >= 0 ? '+' : '') + formatNumber(deltaSubs);
        deltaViewsEl.textContent = (deltaViews >= 0 ? '+' : '') + formatNumber(deltaViews);
        const deltaDays = Math.max((latest.ts - prev.ts)/(1000*60*60*24), 0.001);
        subsVel = ((deltaSubs / Math.max(prev.subs,1)) / deltaDays) * 100;
        viewsVel = ((deltaViews / Math.max(prev.views,1)) / deltaDays) * 100;
        velocityEl.textContent = `${subsVel >= 0 ? '+' : ''}${subsVel.toFixed(2)}%/day`;
        viewVelocityEl.textContent = `${viewsVel >= 0 ? '+' : ''}${viewsVel.toFixed(2)}%/day`;
        const projectionSubs = latest.subs + (subsVel/100)*latest.subs*30;
        projectionEl.textContent = `${projectionSubs >= 0 ? '+' : ''}${formatNumber(Math.round(projectionSubs - latest.subs))}`;
      } else {
        prevSubsEl.textContent = 'â€”';
        prevViewsEl.textContent = 'â€”';
        deltaSubsEl.textContent = 'â€”';
        deltaViewsEl.textContent = 'â€”';
        velocityEl.textContent = 'â€”';
        viewVelocityEl.textContent = 'â€”';
        projectionEl.textContent = 'â€”';
      }
      lastSnapshotTimeEl.textContent = latest ? `Last saved: ${new Date(latest.ts).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true})}` : '';
      drawSparkline(document.getElementById('subsSpark'), history.map(h => h.subs));
      drawSparkline(document.getElementById('viewsSpark'), history.map(h => h.views));
      return { subsVelocityPercentPerDay: subsVel, viewsVelocityPercentPerDay: viewsVel, latest, prev };
    }

    function computeGrade(subsVelocity, engagementRate, subsCount) {
      let score = 0;
      if (subsCount >= 1_000_000) score += 2;
      else if (subsCount >= 100_000) score += 1;
      if (engagementRate >= 5) score += 2;
      else if (engagementRate >= 2) score += 1;
      if (subsVelocity > 0) score += 1;
      else if (subsVelocity < -0.5) score -= 1;
      if (score >= 4) return 'A';
      if (score === 3) return 'B';
      if (score === 2) return 'C';
      if (score === 1) return 'D';
      return 'E';
    }

    function formatEarnings(views) {
      const low = (views / 1000) * 0.25;
      const high = (views / 1000) * 4;
      return `$${low.toLocaleString(undefined,{maximumFractionDigits:0})} - $${high.toLocaleString(undefined,{maximumFractionDigits:0})}`;
    }

    function computeUploadFrequency(videos) {
      if (!videos || videos.length < 2) return { avg: null, count: videos.length };
      const dates = videos
        .map(v => new Date(v.snippet?.publishedAt))
        .filter(d => !isNaN(d))
        .sort((a,b)=> b - a);
      if (dates.length < 2) return { avg: null, count: dates.length };
      const intervals = [];
      for (let i=0;i<dates.length-1;i++) {
        intervals.push((dates[i] - dates[i+1])/(1000*60*60*24));
      }
      const avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
      return { avg, count: dates.length };
    }

    function setupShareLink() {
      const full = `${location.origin}${location.pathname}?channelId=${encodeURIComponent(channelId)}`;
      if (shareLinkInput) shareLinkInput.value = full;
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(full).then(() => {
          copyBtn.textContent = 'Copied';
          setTimeout(()=> copyBtn.textContent = 'Copy', 1000);
        });
      });
    }

    async function fetchChannelInfo(id) {
      const url = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,contentDetails,brandingSettings&id=${encodeURIComponent(id)}&key=${encodeURIComponent(YT_API_KEY)}`;
      const res = await fetch(url);
      if (!res.ok) {
        const payload = await res.json().catch(()=>null);
        throw new Error(payload?.error?.message || `HTTP ${res.status}`);
      }
      const json = await res.json();
      if (!json.items || !json.items.length) throw new Error('Channel not found');
      return json.items[0];
    }

    async function fetchRecentUploads(playlistId, max = 12) {
      const listUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${encodeURIComponent(playlistId)}&maxResults=${max}&key=${encodeURIComponent(YT_API_KEY)}`;
      const listRes = await fetch(listUrl);
      if (!listRes.ok) {
        const payload = await listRes.json().catch(()=>null);
        throw new Error(payload?.error?.message || `HTTP ${listRes.status}`);
      }
      const listJson = await listRes.json();
      if (!listJson.items) return [];
      const videoIds = listJson.items.map(i => i.snippet.resourceId.videoId).filter(Boolean);
      if (!videoIds.length) return [];
      const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${encodeURIComponent(videoIds.join(','))}&key=${encodeURIComponent(YT_API_KEY)}`;
      const vidRes = await fetch(videosUrl);
      if (!vidRes.ok) {
        const payload = await vidRes.json().catch(()=>null);
        throw new Error(payload?.error?.message || `HTTP ${vidRes.status}`);
      }
      const vidJson = await vidRes.json();
      return vidJson.items || [];
    }

    function renderRecentVideos(videos) {
      videosTbody.innerHTML = '';
      videos.forEach((v, idx) => {
        const title = v.snippet?.title || 'Untitled';
        const thumb = v.snippet?.thumbnails?.medium?.url || '';
        const published = timeAgo(v.snippet?.publishedAt || '');
        const viewCount = v.statistics?.viewCount ? formatNumber(v.statistics.viewCount) : 'â€”';
        const duration = parseDuration(v.contentDetails?.duration);
        const videoId = v.id;
        const videoUrl = `https://youtu.be/${videoId}`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>
            <div class="thumb">
              <a href="${videoUrl}" target="_blank">
                <img loading="lazy" src="${thumb}" alt="${title}" />
              </a>
              <div class="video-info">
                <div class="video-title"><a href="${videoUrl}" target="_blank">${title}</a></div>
                <div class="video-meta">
                  <div class="small">${v.snippet?.channelTitle || ''}</div>
                </div>
              </div>
            </div>
          </td>
          <td class="small">${published}</td>
          <td>${viewCount}</td>
          <td class="small">${duration}</td>
          <td><a href="${videoUrl}" target="_blank" class="btn" style="padding:6px 12px;font-size:.65em;">Watch</a></td>
        `;
        videosTbody.appendChild(tr);
      });
    }

    function gradeSubscriberGain(gain) {
      if (gain === null || gain === undefined) return 'â€”';
      if (gain >= 3000000) return 'A++';
      if (gain >= 1000000) return 'A+';
      if (gain >= 500000) return 'A';
      if (gain >= 100000) return 'B';
      if (gain >= 50000) return 'C';
      if (gain >= 10000) return 'D';
      if (gain >= 0) return 'F';
      return 'F';
    }
    function gradeViewGain(gain) {
      if (gain === null || gain === undefined) return 'â€”';
      if (gain >= 500000000) return 'A++';
      if (gain >= 200000000) return 'A+';
      if (gain >= 100000000) return 'A';
      if (gain >= 25000000) return 'B';
      if (gain >= 10000000) return 'C';
      if (gain >= 2000000) return 'D';
      if (gain >= 0) return 'F';
      return 'F';
    }
    function applyGainGradeStyle(el, grade) {
      const mapping = {
        'A++': '#16c784',
        'A+': '#22c55e',
        'A': '#3b82f6',
        'B': '#f59e0b',
        'C': '#f97316',
        'D': '#ef4444',
        'F': '#d33f3f',
      };
      if (!el) return;
      if (grade === 'â€”') {
        el.textContent = 'â€”';
        el.style.background = 'rgba(255,255,255,0.07)';
        el.style.color = '#ccc';
      } else {
        el.textContent = grade;
        el.style.background = mapping[grade] || '#6b7280';
        el.style.color = '#fff';
      }
    }

    function gradeRealtimeSubsGain(ratePerHour) {
      if (ratePerHour >= 500000) return 'A++';
      if (ratePerHour >= 200000) return 'A+';
      if (ratePerHour >= 80000) return 'A';
      if (ratePerHour >= 25000) return 'B';
      if (ratePerHour >= 8000) return 'C';
      if (ratePerHour >= 2000) return 'D';
      if (ratePerHour >= 0) return 'F';
      return 'â€”';
    }
    function gradeRealtimeViewsGain(ratePerHour) {
      if (ratePerHour >= 1000000000) return 'A++';
      if (ratePerHour >= 500000000) return 'A+';
      if (ratePerHour >= 200000000) return 'A';
      if (ratePerHour >= 50000000) return 'B';
      if (ratePerHour >= 15000000) return 'C';
      if (ratePerHour >= 5000000) return 'D';
      if (ratePerHour >= 0) return 'F';
      return 'â€”';
    }
    function applyGrade(el, grade) {
      const map = {
        'A++': '#16c784',
        'A+': '#22c55e',
        'A': '#3b82f6',
        'B': '#f59e0b',
        'C': '#f97316',
        'D': '#ef4444',
        'F': '#d33f3f',
      };
      if (!el) return;
      if (!grade || grade === 'â€”') {
        el.textContent = 'â€”';
        el.style.background = 'rgba(255,255,255,0.07)';
        el.style.color = '#ccc';
      } else {
        el.textContent = grade;
        el.style.background = map[grade] || '#6b7280';
        el.style.color = '#fff';
      }
    }

    function drawRealtimeSpark(canvas, values) {
      const ctx = canvas.getContext('2d');
      const dpr = devicePixelRatio || 1;
      const w = canvas.clientWidth * dpr;
      const h = canvas.clientHeight * dpr;
      canvas.width = w;
      canvas.height = h;
      ctx.resetTransform();
      ctx.scale(dpr, dpr);
      const displayW = canvas.clientWidth;
      const displayH = canvas.clientHeight;
      ctx.clearRect(0,0,displayW,displayH);
      if (!values.length) return;
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = Math.max(1, max - min);
      const pad = 6;
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#fff';
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.beginPath();
      values.forEach((v,i) => {
        const x = pad + (i / (values.length -1)) * (displayW - pad*2);
        const y = pad + ((max - v)/range)*(displayH - pad*2);
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.lineTo(displayW - pad, displayH - pad);
      ctx.lineTo(pad, displayH - pad);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      values.forEach((v,i) => {
        const x = pad + (i / (values.length -1)) * (displayW - pad*2);
        const y = pad + ((max - v)/range)*(displayH - pad*2);
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();
    }

    function showAnalyticsVerification() {
      if (!channelId || !viewStatsVerified[channelId]) return;
      const info = viewStatsVerified[channelId];
      const container = document.createElement('div');
      container.className = 'verification-banner';
      const now = new Date();
      container.innerHTML = `
        <div class="check">âœ…</div>
        <div>
          <div style="font-weight:700; font-size:1.05rem;">Subscriber Count Verified</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
            <div>${info.displayName} is in the ViewStats verified list.</div>
            <div>${info.note}</div>
            <div style="font-size:.65em; color: #0f1f2f;">Verified: ${now.toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true})}</div>
          </div>
        </div>
      `;
      verificationContainer.appendChild(container);
    }
    function showRealtimeVerification() {
      if (!channelId || !viewStatsVerified[channelId]) return;
      realtimeVerificationEl.classList.remove('hidden');
      const info = viewStatsVerified[channelId];
      realtimeVerificationText.textContent = `${info.displayName}: ${info.note}`;
    }

    // Mixerno.Space API
    async function fetchMixernoSubscriberCount(channelId) {
      try {
        const res = await fetch(`https://mixerno.space/api/youtube-channel-counter/user/${encodeURIComponent(channelId)}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Mixerno API error ${res.status}`);
        const data = await res.json();
        const subs = data?.counts?.[0]?.count;
        if (subs != null) return Number(subs);
        return null;
      } catch (e) {
        console.warn('Mixerno.Space API error:', e);
        return null;
      }
    }

    function pushRealtime(point) {
      realtimeHistory.push(point);
      if (realtimeHistory.length > 180) realtimeHistory.shift();
    }

    function updateRealtimeDisplay(subs, views) {
      subsRealtimeEl.innerText = subs;
      viewsRealtimeEl.innerText = views;
      liveLastUpdatedEl.textContent = `Updated ${new Date().toLocaleTimeString('en-US',{hour12:true, hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;

      const now = Date.now();
      function windowDelta(ms) {
        const cutoff = now - ms;
        const relevant = realtimeHistory.filter(h => h.ts >= cutoff);
        if (relevant.length < 2) return null;
        const first = relevant[0];
        const last = relevant[relevant.length -1];
        const durationHours = (last.ts - first.ts)/(1000*60*60);
        if (durationHours <= 0) return null;
        return {
          deltaSubs: last.subs - first.subs,
          deltaViews: last.views - first.views,
          rateSubsPerHour: (last.subs - first.subs) / durationHours,
          rateViewsPerHour: (last.views - first.views) / durationHours
        };
      }

      const w5 = windowDelta(5*60*1000);
      const w1 = windowDelta(1*60*1000);
      const best = w5 || w1;

      if (best) {
        const subsRate = Math.round(best.rateSubsPerHour);
        const viewsRate = Math.round(best.rateViewsPerHour);
        subsRateEl.textContent = `${subsRate >= 0 ? '+' : ''}${formatNumber(subsRate)}`;
        viewsRateEl.textContent = `${viewsRate >= 0 ? '+' : ''}${formatNumber(viewsRate)}`;
        projSubsDayEl.textContent = subsRate !== null ? (subsRate*24 >=0?'+':'') + formatNumber(Math.round(subsRate * 24)) : 'â€”';
        projViewsDayEl.textContent = viewsRate !== null ? (viewsRate*24 >=0?'+':'') + formatNumber(Math.round(viewsRate * 24)) : 'â€”';
        applyGrade(realtimeSubsGainGradeEl, gradeRealtimeSubsGain(best.rateSubsPerHour));
        applyGrade(realtimeViewsGainGradeEl, gradeRealtimeViewsGain(best.rateViewsPerHour));
      } else {
        subsRateEl.textContent = 'â€”';
        viewsRateEl.textContent = 'â€”';
        projSubsDayEl.textContent = 'â€”';
        projViewsDayEl.textContent = 'â€”';
        applyGrade(realtimeSubsGainGradeEl, 'â€”');
        applyGrade(realtimeViewsGainGradeEl, 'â€”');
      }

      drawRealtimeSpark(sparkSubs, realtimeHistory.map(h => h.subs));
      drawRealtimeSpark(sparkViews, realtimeHistory.map(h => h.views));
    }

    function update30DaySection(history) {
      const now = Date.now();
      const cutoff = now - 30 * 24 * 60 * 60 * 1000;
      const dayMap = {};
      history.forEach(h => {
        if (h.ts < cutoff) return;
        const key = new Date(h.ts).toISOString().slice(0,10);
        if (!dayMap[key] || h.ts > dayMap[key].ts) dayMap[key] = h;
      });
      const arr = [];
      for (let i = 29; i >= 0; i--) {
        const d = new Date(now - i * 24 * 60 * 60 * 1000);
        const key = d.toISOString().slice(0,10);
        arr.push({
          date: key,
          subs: dayMap[key]?.subs ?? null,
          views: dayMap[key]?.views ?? null
        });
      }
      let lastValidSubs = null;
      let firstValidSubs = null;
      let lastValidViews = null;
      let firstValidViews = null;
      const rows = [];
      for (let i = 0; i < arr.length; i++) {
        const curr = arr[i];
        const prev = i > 0 ? arr[i-1] : null;
        let deltaSubs = null;
        let deltaViews = null;
        if (curr.subs !== null && prev && prev.subs !== null) deltaSubs = curr.subs - prev.subs;
        if (curr.views !== null && prev && prev.views !== null) deltaViews = curr.views - prev.views;
        if (curr.subs !== null) {
          if (firstValidSubs === null) firstValidSubs = curr.subs;
          lastValidSubs = curr.subs;
        }
        if (curr.views !== null) {
          if (firstValidViews === null) firstValidViews = curr.views;
          lastValidViews = curr.views;
        }
        rows.push({
          date: curr.date,
          subs: curr.subs,
          deltaSubs,
          views: curr.views,
          deltaViews
        });
      }
      const tbody = document.querySelector('#thirtyDayTable tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const dateDisplay = new Date(r.date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
        const subsCell = r.subs !== null ? formatNumber(r.subs) : 'â€”';
        const deltaSubsCell = r.deltaSubs !== null ? ((r.deltaSubs >= 0 ? '+' : '') + formatNumber(r.deltaSubs)) : 'â€”';
        const viewsCell = r.views !== null ? formatNumber(r.views) : 'â€”';
        const deltaViewsCell = r.deltaViews !== null ? ((r.deltaViews >= 0 ? '+' : '') + formatNumber(r.deltaViews)) : 'â€”';
        tr.innerHTML = `
          <td>${dateDisplay}</td>
          <td>${subsCell}</td>
          <td>${deltaSubsCell}</td>
          <td>${viewsCell}</td>
          <td>${deltaViewsCell}</td>
        `;
        tbody.appendChild(tr);
      });
      let totalSubsGain = (lastValidSubs !== null && firstValidSubs !== null) ? lastValidSubs - firstValidSubs : null;
      let totalViewsGain = (lastValidViews !== null && firstValidViews !== null) ? lastValidViews - firstValidViews : null;
      const avgSubsPerDay = totalSubsGain !== null ? totalSubsGain / 30 : null;
      const avgViewsPerDay = totalViewsGain !== null ? totalViewsGain / 30 : null;

      totalSubsGainEl.textContent = totalSubsGain !== null ? (totalSubsGain >=0 ? '+' : '') + formatNumber(totalSubsGain) : 'â€”';
      avgSubsPerDayEl.textContent = avgSubsPerDay !== null ? (avgSubsPerDay >=0 ? '+' : '') + formatNumber(Math.round(avgSubsPerDay)) : 'â€”';
      totalViewsGainEl.textContent = totalViewsGain !== null ? (totalViewsGain >=0 ? '+' : '') + formatNumber(totalViewsGain) : 'â€”';
      avgViewsPerDayEl.textContent = avgViewsPerDay !== null ? (avgViewsPerDay >=0 ? '+' : '') + formatNumber(Math.round(avgViewsPerDay)) : 'â€”';

      if (totalSubsGain !== null && totalViewsGain !== null) {
        thirtyDaySummaryEl.textContent = `Subs: ${(totalSubsGain>=0?'+':'')+formatNumber(totalSubsGain)} over 30d Â· Views: ${(totalViewsGain>=0?'+':'')+formatNumber(totalViewsGain)} over 30d`;
      } else {
        thirtyDaySummaryEl.textContent = 'Insufficient data for 30d summary';
      }

      applyGainGradeStyle(subsGainGradeEl, gradeSubscriberGain(totalSubsGain));
      applyGainGradeStyle(viewsGainGradeEl, gradeViewGain(totalViewsGain));
    }

    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(o => o.classList.remove('active'));
        t.classList.add('active');
        const target = t.dataset.target;
        ['analyticsContent','videoAnalyticsContent','realtimeContent','leaderboardContent'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.classList.toggle('hidden', id !== target);
        });
      });
    });

    async function initAnalytics() {
      if (!channelId) return;
      setupShareLink();
      try {
        const channel = await fetchChannelInfo(channelId);
        const title = channel.snippet?.title || 'Unknown';
        channelNameEl.textContent = title;
        channelSubtitleEl.textContent = `Analytics for ${title}`;
        channelAvatarEl.src = channel.snippet?.thumbnails?.high?.url || '';
        const rawCustom = channel.snippet?.customUrl || '';
        customUrlEl.textContent = rawCustom ? (rawCustom.startsWith('@') ? rawCustom : '@' + rawCustom) : '';
        publishedDateEl.textContent = channel.snippet?.publishedAt ? `Created ${timeAgo(channel.snippet.publishedAt)}` : '';
        countryEl.textContent = channel.snippet?.country || channel.brandingSettings?.channel?.country || '';
        const fullDescription = channel.snippet?.description || '';
        descriptionShortEl.textContent = fullDescription.length > 160 ? fullDescription.slice(0,160) + '...' : fullDescription;

        const subsRaw = channel.statistics?.hiddenSubscriberCount ? 0 : Number(channel.statistics?.subscriberCount || 0);
        const viewsRaw = Number(channel.statistics?.viewCount || 0);
        const videoCnt = Number(channel.statistics?.videoCount || 0);
        subsOdoEl.innerText = subsRaw;
        viewsOdoEl.innerText = viewsRaw;
        videoCountEl.textContent = formatNumber(videoCnt);

        analyticsHistory = await getHistory(channelId);
        let histRes = updateAnalyticsHistoryDisplay(analyticsHistory);
        if (!analyticsHistory.length) {
          histRes = await recordAnalyticsSnapshot({ subs: subsRaw, views: viewsRaw });
          analyticsHistory = await getHistory(channelId);
        }

        update30DaySection(analyticsHistory);

        const uploadsPlaylist = channel.contentDetails?.relatedPlaylists?.uploads;
        let recentVideos = [];
        if (uploadsPlaylist) {
          try {
            recentVideos = await fetchRecentUploads(uploadsPlaylist, 12);
            renderRecentVideos(recentVideos);
          } catch (e) {
            videosError.innerHTML = `<div class="error">Failed to load recent uploads: ${e.message}</div>`;
          }
        }

        let engagementRate = 0;
        if (recentVideos.length) {
          const totalViews = recentVideos.reduce((sum, v) => {
            const cnt = v.statistics?.viewCount ? Number(v.statistics.viewCount) : 0;
            return sum + cnt;
          }, 0);
          const avgViewsPerVideo = totalViews / recentVideos.length;
          engagementRate = subsRaw > 0 ? (avgViewsPerVideo / subsRaw) * 100 : 0;
        }
        engagementEl.textContent = engagementRate ? `${engagementRate.toFixed(2)}%` : 'â€”';

        const subsVel = histRes.subsVelocityPercentPerDay || 0;
        const gradeLetter = computeGrade(subsVel, engagementRate, subsRaw);
        gradeEl.textContent = gradeLetter;
        const gradeColorMap = { A: '#22c55e', B: '#3b82f6', C: '#f59e0b', D: '#f97316', E: '#ef4444' };
        gradeEl.style.background = gradeColorMap[gradeLetter] || '#6b7280';

        const viewsVel = histRes.viewsVelocityPercentPerDay || 0;
        const latestViews = histRes.latest?.views || viewsRaw;
        const projectedMonthlyViews = latestViews + (viewsVel / 100) * latestViews * 30;
        estMonthlyEl.textContent = projectedMonthlyViews > 0 ? formatEarnings(projectedMonthlyViews) : 'â€”';
        estYearlyEl.textContent = projectedMonthlyViews > 0 ? formatEarnings(projectedMonthlyViews * 12) : 'â€”';

        const { avg, count } = computeUploadFrequency(recentVideos);
        if (avg !== null) {
          uploadFreqEl.textContent = avg < 1 ? '<1 day' : `${avg.toFixed(1)} days (${count} uploads)`;
        } else {
          uploadFreqEl.textContent = count ? `${count} upload(s)` : 'â€”';
        }

        showAnalyticsVerification();
      } catch (err) {
        const errBox = document.createElement('div');
        errBox.classList.add('error');
        errBox.textContent = `Failed to load channel: ${err.message}`;
        document.querySelector('.container').prepend(errBox);
      }
    }

    async function initRealtime() {
      if (!channelId) return;
      try {
        const channel = await fetchChannelInfo(channelId);
        const subs = channel.statistics?.hiddenSubscriberCount ? 0 : Number(channel.statistics?.subscriberCount || 0);
        const views = Number(channel.statistics?.viewCount || 0);
        lastKnownViews = views;
        pushRealtime({ ts: Date.now(), subs, views });
        updateRealtimeDisplay(subs, views);
        showRealtimeVerification();
      } catch (e) {
        console.warn('Realtime init error', e);
      }
      setTimeout(tickMixerno, 2000);
      setTimeout(tickYouTubeViews, 8000);
    }

    async function tickYouTubeViews() {
      if (!channelId) return;
      try {
        const statsUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${encodeURIComponent(channelId)}&key=${encodeURIComponent(YT_API_KEY)}`;
        const res = await fetch(statsUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (!json.items || !json.items.length) throw new Error('No data');
        const st = json.items[0].statistics;
        const views = Number(st?.viewCount || 0);
        lastKnownViews = views;
        const last = realtimeHistory[realtimeHistory.length - 1] || {};
        const currentSubs = last.subs !== undefined ? last.subs : 0;
        pushRealtime({ ts: Date.now(), subs: currentSubs, views });
        updateRealtimeDisplay(currentSubs, views);
      } catch (e) {
        console.warn('YouTube realtime views poll error', e);
      } finally {
        setTimeout(tickYouTubeViews, 10000);
      }
    }

    async function tickMixerno() {
      if (!channelId) return;
      try {
        const subs = await fetchMixernoSubscriberCount(channelId);
        if (subs !== null) {
          const last = realtimeHistory[realtimeHistory.length - 1] || {};
          const currentViews = last.views !== undefined ? last.views : lastKnownViews;
          pushRealtime({ ts: Date.now(), subs, views: currentViews });
          updateRealtimeDisplay(subs, currentViews);
        }
      } catch (e) {
        console.warn('Mixerno subs-only error', e);
      } finally {
        setTimeout(tickMixerno, 5000);
      }
    }

    snapshotBtn.addEventListener('click', async () => {
      const subsVal = parseInt(subsOdoEl.innerText.replace(/,/g,'')) || 0;
      const viewsVal = parseInt(viewsOdoEl.innerText.replace(/,/g,'')) || 0;
      await recordAnalyticsSnapshot({ subs: subsVal, views: viewsVal });
      analyticsHistory = await getHistory(channelId);
      update30DaySection(analyticsHistory);
    });
    refreshVideosBtn.addEventListener('click', async () => {
      if (!channelId) return;
      videosError.innerHTML = `<div class="small">Refreshing uploads...</div>`;
      try {
        const channel = await fetchChannelInfo(channelId);
        const uploadsPlaylist = channel.contentDetails?.relatedPlaylists?.uploads;
        if (uploadsPlaylist) {
          const recentVideos = await fetchRecentUploads(uploadsPlaylist, 12);
          renderRecentVideos(recentVideos);
          videosError.innerHTML = '';
          const { avg, count } = computeUploadFrequency(recentVideos);
          if (avg !== null) {
            uploadFreqEl.textContent = avg < 1 ? '<1 day' : `${avg.toFixed(1)} days (${count} uploads)`;
          }
        }
      } catch (e) {
        videosError.innerHTML = `<div class="error">Error refreshing videos: ${e.message}</div>`;
      }
    });

    // Beta banner dismissal
    (function() {
      const banner = document.querySelector('.beta-banner');
      if (!banner) return;
      if (localStorage.getItem('hideBetaBanner')) {
        banner.remove();
        return;
      }
      const close = document.getElementById('betaClose');
      if (close) {
        close.addEventListener('click', () => {
          localStorage.setItem('hideBetaBanner', '1');
          banner.remove();
        });
      }
    })();

    document.addEventListener('DOMContentLoaded', () => {
      initAnalytics();
      initRealtime();
      document.querySelectorAll('.tab').forEach(t => {
        if (t.classList.contains('active')) {
          const target = t.dataset.target;
          ['analyticsContent','videoAnalyticsContent','realtimeContent','leaderboardContent'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('hidden', el.id !== target);
          });
        }
      });
    });
  </script>
</body>
</html>
